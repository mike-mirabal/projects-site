<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>GHOST DONKEY Spirit Guide</title>
  <style>
    :root{
      --bg:#f9e7e7;
      --accent:#ee4d36;
      --teal:#55c4bb;
      --text:#09080a;
      --muted:#f3d9d9;
      --maxw:1100px;
      --border:2px;
      --radius:0;             /* square corners */
      --app-h: 100vh;         /* updated via JS to visible viewport height */
      --composer-h: 88px;     /* updated via JS to input bar height */
    }

    /* No page scroll; only chat scrolls */
    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--text);
      overflow:hidden;
      font-family:"Futura PT", Futura, "Avenir Next", Avenir, Arial, sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .app{
      height:var(--app-h);           /* visible viewport height (handles mobile keyboard) */
      max-width:var(--maxw);
      margin:0 auto;
      padding-inline: clamp(16px, 4vw, 40px);
      display:flex;
      flex-direction:column;
      gap:12px;
      box-sizing:border-box;
      overscroll-behavior:contain;
    }

    /* ===== Top bar (sticky) ===== */
    .topbar{
      position:sticky;
      top:env(safe-area-inset-top, 0);
      z-index:10;
      background:var(--bg);
      display:grid;
      grid-template-columns: 1fr auto; /* title left, toggle right */
      align-items:center;
      gap:12px;
      padding:8px 0 2px;
    }

    .brand{
      font-size: 1.75rem;
      line-height:1.05;
      margin:0;
      font-weight:700;
      letter-spacing:.3px;
      display:flex;
      gap:10px;
      align-items:baseline;
      flex-wrap:wrap;
    }
    /* scale title down on tablets/phones */
    @media (max-width: 768px) {
      .brand{ font-size: 1.2rem; }
    }
    .brand .gd{
      font-weight:900;
      color:var(--teal);
      text-shadow: 2px 0 var(--accent), -2px 0 var(--accent), 0 2px var(--accent), 0 -2px var(--accent);
    }
    .brand .sg{
      color:var(--accent);
      font-weight:600;
    }
    /* stack title on narrow screens while keeping toggle on the right */
    @media (max-width:768px){
      .brand{ display:block; }
      .brand .line{ display:block; }
      .brand .gd{
        font-weight:600;
        text-shadow: 1px 0 var(--accent), -1px 0 var(--accent), 0 1px var(--accent), 0 -1px var(--accent);
      }
    }

    /* ===== Toggle ===== */
    .toggle{
      display:inline-flex;
      border:var(--border) solid var(--accent);
      /* border-radius:999px; */
      padding:3px;
      gap:4px;
      background:transparent;
    }
    .toggle button{
      all:unset;
      padding:8px 12px;
      font-size:.75rem;
      font-weight:700;
      /* border-radius:999px; */
      cursor:pointer;
      color:var(--text);
    }
    @media (max-width:560px){
      .toggle button{ padding:6px 8px; font-size:.75rem; }
    }
    .toggle .on{ background:var(--teal); color:#fff; }
    .toggle .off{ background:transparent; color:var(--accent); }

    .accent-strong{ color:var(--teal); font-weight:800; }


    /* ===== Divider ===== */
    .divider{
      flex:0 0 auto;
      display:block;
      width:100%;
      height:auto;
      margin:6px 0 6px;
      object-fit:contain;
    }
    @media (max-width:560px){
      .divider{ display:none; }
    }

    /* ===== Chat panel (fills remaining height) ===== */
    .panel{
      flex:1 1 auto;
      min-height:0; /* critical to allow inner scroll to size */
      border:var(--border) solid var(--accent);
      background:var(--muted);
      padding: clamp(14px, 2vw, 20px);
      overflow:hidden; /* wrapper has no scrollbars */
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-bottom: 1rem; /* buffer handled by sticky input padding */
    }

    /* Only this scrolls */
    .scroll{
      flex:1 1 auto;
      min-height:0;
      overflow-y:auto;
      padding-right:4px; /* space for scrollbar */
      /* keep last message clear of the sticky input bar */
      padding-bottom: calc(var(--composer-h) + 16px);
    }

    /* Messages */
    .msg{ margin:10px 0; font-size:clamp(15px, 1.15vw, 18px); line-height:1.35; }
    .msg.ai{ /* plain text */ }
    .msg.user{
      padding:8px;
      border-bottom:var(--border) solid var(--accent);
      border-radius:var(--radius);
      margin-left:auto;
      max-width:min(720px, 90%);
      background:transparent;
    }
    .accent-teal{ color:var(--teal); font-weight:800; }

    /* ===== Input bar (sticky bottom) ===== */
    .inputbar{
      position:sticky;
      bottom:0;
      z-index:10;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .inputbar .field{
      flex:1 1 auto; min-width:0; /* prevents wrapping */
      display:flex; align-items:center; gap:10px;
      border:var(--border) solid var(--accent);
      background:var(--bg);
      padding:8px 10px;
      border-radius:var(--radius);
    }
    .field input{
      all:unset;
      flex:1 1 auto; min-width:0;
      font-size:clamp(15px, 1.1vw, 17px);
      line-height:1.2;
      color:var(--text);
    }
    .send{
      flex:0 0 auto;
      height:40px; width:44px;
      border:var(--border) solid var(--accent);
      background:var(--accent);
      color:#fff;
      border-radius:var(--radius);
      cursor:pointer;
      display:grid; place-items:center;
      font-size:18px; font-weight:900;
    }
    .send:disabled{ opacity:.55; cursor:not-allowed; }

    .hint{
      font-size:clamp(12px, .95vw, 14px);
      text-align:center;
      padding-top:6px;
      padding-bottom:6px;
    }
    .hint .b{ color:var(--teal); font-weight:800; }
    .hint .a{ color:var(--accent); font-weight:800; }

    /* Desktop horizontal breathing */
    @media (min-width:1100px){
      .app{ padding-inline:56px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Top bar -->
    <div class="topbar">
      <h1 class="brand" aria-label="GHOST DONKEY Spirit Guide">
        <span class="line gd">GHOST DONKEY</span>
        <span class="line sg">Spirit Guide</span>
      </h1>
     <div class="toggle" role="tablist" aria-label="Mode">
        <button id="staffBtn" class="on" role="tab" aria-selected="true">Staff</button>
        <button id="guestBtn" class="off" role="tab" aria-selected="false">Guest</button>
     </div>
    </div>

    <!-- Floral divider -->
    <img class="divider" src="GD_FloralDivider.webp" alt="floral divider" />

    <!-- Chat panel -->
    <section class="panel" aria-label="Chat">
      <div id="chat" class="scroll" aria-live="polite" aria-relevant="additions"></div>

      <!-- Input row -->
      <div id="composer" class="inputbar">
        <div class="field">
          <input id="input" type="text" placeholder="Ask anything..." />
        </div>
        <button id="send" class="send" title="Send" aria-label="Send">➤</button>
      </div>

      <div class="hint">
        <span class="b">Staff</span> shows builds & specs • <span class="a">Guest</span> is menu & ordering.
      </div>
    </section>
  </div>

  <script>
  // Elements
  const chatEl   = document.getElementById('chat');
  const inputEl  = document.getElementById('input');
  const sendBtn  = document.getElementById('send');
  const guestBtn = document.getElementById('guestBtn');
  const staffBtn = document.getElementById('staffBtn');
  const composer = document.getElementById('composer');

  let mode = 'staff'; // 'guest' | 'staff'

  function appendAI(text){
    const div = document.createElement('div');
    div.className = 'msg ai';
    // accent **bold** phrases
    div.innerHTML = (text || '').replace(/\*\*(.+?)\*\*/g, '<span class="accent-teal">$1</span>');
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
  }
  function appendUser(text){
    const div = document.createElement('div');
    div.className = 'msg user';
    div.textContent = text;
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function setMode(next){
    mode = next;
    const isGuest = mode === 'guest';

    // Toggle UI state
    staffBtn.className = isGuest ? 'off' : 'on';
    guestBtn.className = isGuest ? 'on' : 'off';
    staffBtn.setAttribute('aria-selected', String(!isGuest));
    guestBtn.setAttribute('aria-selected', String(isGuest));

    // Reset chat and show mode banner message (no greeting line)
    chatEl.innerHTML = '';
    const banner = isGuest
      ? `<span class="accent-strong">GUEST MODE</span>: Get more information about the menu, ingredients, and prices.`
      : `<span class="accent-strong">STAFF MODE</span>: Ask for Recipes, Get Info, or Test your knowledge.`;
    appendAI(banner);
  }

  staffBtn.onclick = () => setMode('staff');
  guestBtn.onclick = () => setMode('guest');

  async function send(){
    const text = (inputEl.value || '').trim();
    if(!text) return;
    appendUser(text);
    inputEl.value = '';
    sendBtn.disabled = true;
    try{
      const res = await fetch('/api/chat', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ query: text, mode })
      });
      if(!res.ok){
        const t = await res.text().catch(()=> '');
        appendAI(`A server error occurred (${res.status}).`);
        console.error('API error', res.status, t);
        return;
      }
      const data = await res.json();
      if (Array.isArray(data.bubbles)) {
        data.bubbles.forEach(b => appendAI(String(b)));
      } else {
        appendAI(data.answer || 'No answer.');
      }
    }catch(err){
      console.error(err);
      appendAI('Network error. Try again.');
    }finally{
      sendBtn.disabled = false;
      inputEl.focus();
    }
  }

  // Enter to send
  inputEl.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){ e.preventDefault(); send(); }
  });
  sendBtn.addEventListener('click', send);

  // ===== Visual Viewport handling =====
  function setAppHeight(){
    const h = (window.visualViewport && window.visualViewport.height)
      ? window.visualViewport.height
      : window.innerHeight;
    document.documentElement.style.setProperty('--app-h', `${Math.round(h)}px`);
  }
  function setComposerHeight(){
    const h = composer ? composer.getBoundingClientRect().height : 88;
    document.documentElement.style.setProperty('--composer-h', `${Math.ceil(h)}px`);
  }
  function syncHeights(){
    setAppHeight();
    setComposerHeight();
  }
  window.addEventListener('resize', syncHeights);
  window.addEventListener('orientationchange', syncHeights);
  if (window.visualViewport){
    window.visualViewport.addEventListener('resize', syncHeights);
    window.visualViewport.addEventListener('scroll', syncHeights);
  }

  // ---- First load (STAFF by default) ----
  setMode('staff');   // << keep this
  syncHeights();
  setTimeout(syncHeights, 150);
  setTimeout(syncHeights, 600);
</script>

</body>
</html>
